# =============================================================================
# Xavyo Suite - Local Development Environment
# =============================================================================
# Usage:
#   Start:  docker compose up -d
#   Stop:   docker compose down
#   Logs:   docker compose logs -f
#   Reset:  docker compose down -v && docker compose up -d

services:
  # ===========================================================================
  # Kafka (KRaft mode - no Zookeeper required)
  # ===========================================================================
  kafka:
    image: apache/kafka:3.7.0
    container_name: xavyo-kafka
    restart: unless-stopped
    environment:
      # KRaft settings
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@localhost:9093
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      # Listeners
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093,EXTERNAL://:9094
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,EXTERNAL://localhost:9094
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT,EXTERNAL:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      # Cluster settings
      CLUSTER_ID: xavyo-kafka-cluster-001
      # Auto-create topics
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
      KAFKA_NUM_PARTITIONS: 3
      KAFKA_DEFAULT_REPLICATION_FACTOR: 1
      # Performance
      KAFKA_LOG_RETENTION_HOURS: 24
      KAFKA_LOG_SEGMENT_BYTES: 1073741824
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
    ports:
      - '${KAFKA_PORT:-9094}:9094'
    volumes:
      - kafka_data:/var/lib/kafka/data
    healthcheck:
      test:
        [
          'CMD-SHELL',
          '/opt/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server localhost:9092 || exit 1',
        ]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 30s
    networks:
      - xavyo-network

  # ===========================================================================
  # Mailpit - Email Testing (catches all outbound emails)
  # ===========================================================================
  # Web UI:  http://localhost:8025
  # SMTP:    localhost:1025
  # REST API: http://localhost:8025/api/v1/messages
  mailpit:
    image: axllent/mailpit:latest
    container_name: xavyo-mailpit
    restart: unless-stopped
    ports:
      - '${MAILPIT_SMTP_PORT:-1025}:1025'
      - '${MAILPIT_UI_PORT:-8025}:8025'
    environment:
      # Max stored messages (0 = unlimited)
      MP_MAX_MESSAGES: 500
      # Database path for persistence
      MP_DATABASE: /data/mailpit.db
    volumes:
      - mailpit_data:/data
    networks:
      - xavyo-network

  # ===========================================================================
  # PostgreSQL Database
  # ===========================================================================
  postgres:
    image: postgres:15-alpine
    container_name: xavyo-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-xavyo_test}
      POSTGRES_USER: ${POSTGRES_USER:-xavyo}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-xavyo_test_password}
      # Performance tuning for development
      POSTGRES_INITDB_ARGS: '--encoding=UTF8'
    ports:
      - '${POSTGRES_PORT:-5434}:5432'
    volumes:
      # Persist data between restarts
      - postgres_data:/var/lib/postgresql/data
      # Initialization scripts (run on first start only)
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
      - ./postgres/seed.sql:/docker-entrypoint-initdb.d/02-seed.sql:ro
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER:-xavyo} -d ${POSTGRES_DB:-xavyo_test}']
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    networks:
      - xavyo-network

  # ===========================================================================
  # OpenLDAP - Directory Server for Connector Testing
  # ===========================================================================
  # LDAP:   localhost:1389
  # LDAPS:  localhost:1636
  # Admin:  cn=admin,dc=xavyo,dc=dev / admin_password
  # Base:   dc=xavyo,dc=dev
  openldap:
    image: osixia/openldap:1.5.0
    container_name: xavyo-openldap
    restart: unless-stopped
    environment:
      LDAP_ORGANISATION: Xavyo Dev
      LDAP_DOMAIN: xavyo.dev
      LDAP_BASE_DN: dc=xavyo,dc=dev
      LDAP_ADMIN_PASSWORD: ${LDAP_ADMIN_PASSWORD:-admin_password}
      LDAP_CONFIG_PASSWORD: ${LDAP_CONFIG_PASSWORD:-config_password}
      LDAP_READONLY_USER: 'true'
      LDAP_READONLY_USER_USERNAME: ${LDAP_READONLY_USER:-readonly}
      LDAP_READONLY_USER_PASSWORD: ${LDAP_READONLY_USER_PASSWORD:-readonly_password}
    ports:
      - '${LDAP_PORT:-1389}:389'
      - '${LDAPS_PORT:-1636}:636'
    volumes:
      - openldap_data:/var/lib/ldap
      - openldap_config:/etc/ldap/slapd.d
    healthcheck:
      test: ['CMD-SHELL', 'ldapsearch -x -H ldap://localhost -b dc=xavyo,dc=dev -D cn=admin,dc=xavyo,dc=dev -w $${LDAP_ADMIN_PASSWORD:-admin_password}']
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 15s
    networks:
      - xavyo-network

  # ===========================================================================
  # xavyo IDP API Server
  # ===========================================================================
  idp-api:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: xavyo-idp-api
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      mailpit:
        condition: service_started
    entrypoint: ["/bin/sh", "-c", "export JWT_PRIVATE_KEY=\"$(cat /app/keys/jwt_private.pem)\" JWT_PUBLIC_KEY=\"$(cat /app/keys/jwt_public.pem)\" && exec /app/idp-api"]
    environment:
      DATABASE_URL: postgres://xavyo:${POSTGRES_PASSWORD:-xavyo_test_password}@postgres:5432/${POSTGRES_DB:-xavyo_test}
      ISSUER_URL: ${ISSUER_URL:-http://localhost:8080}
      HOST: 0.0.0.0
      PORT: 8080
      RUST_LOG: ${RUST_LOG:-info}
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000,http://localhost:3001}
      EMAIL_SMTP_HOST: mailpit
      EMAIL_SMTP_PORT: 1025
      EMAIL_SMTP_TLS: 'false'
      EMAIL_SMTP_USERNAME: dev
      EMAIL_SMTP_PASSWORD: dev
      EMAIL_FROM_ADDRESS: noreply@xavyo.local
      FRONTEND_BASE_URL: ${FRONTEND_BASE_URL:-http://localhost:3000}
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@xavyo.local}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-Admin@1234}
    ports:
      - '${API_PORT:-8080}:8080'
    volumes:
      - ./keys:/app/keys:ro
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8080/readyz']
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - xavyo-network

# =============================================================================
# Networks
# =============================================================================
networks:
  xavyo-network:
    driver: bridge
    name: xavyo-network

# =============================================================================
# Volumes
# =============================================================================
volumes:
  postgres_data:
    name: xavyo-postgres-data
  mailpit_data:
    name: xavyo-mailpit-data
  kafka_data:
    name: xavyo-kafka-data
  openldap_data:
    name: xavyo-openldap-data
  openldap_config:
    name: xavyo-openldap-config
