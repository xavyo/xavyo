# yaml-language-server: $schema=https://agentgateway.dev/schema/config
#
# AgentGateway — Production Config for Xavyo IDP Integration
#
# Koyeb deployment:
#   - Admin UI (public):  port 15000 → exposed via Koyeb route
#   - MCP data plane:     port 4000  → internal mesh only
#   - Stats:              port 15020
#   - Readiness:          port 15021
#
# ext-authz runs as a separate internal Koyeb service (gRPC on 50051).

# Admin UI: set via ADMIN_ADDR env var (0.0.0.0:15000)
# Readiness: set via READINESS_ADDR env var (0.0.0.0:15021)

frontendPolicies:
  accessLog:
    add:
      nhi.id: 'extauthz.nhi_id'
      nhi.type: 'extauthz.nhi_type'
      nhi.risk: 'extauthz.risk_level'
      tenant.id: 'extauthz.tenant_id'
      delegation.active: 'extauthz.is_delegated'
      delegation.actor: 'extauthz.actor_nhi_id'
      delegation.depth: 'extauthz.delegation_depth'

binds:
- port: 4000
  listeners:
  - name: mcp-xavyo
    protocol: HTTP
    routes:
    - name: mcp-tools
      backends:
      - mcp:
          targets:
          - name: everything
            stdio:
              cmd: npx
              args:
              - '@modelcontextprotocol/server-everything'
      policies:
        cors:
          allowHeaders:
          - mcp-protocol-version
          - content-type
          - authorization
          - x-tenant-id
          allowOrigins:
          - 'https://app.xavyo.net'
          exposeHeaders:
          - Mcp-Session-Id
        extAuthz:
          host: ext-authz.xavyo-api.koyeb:50051
          protocol:
            grpc: {}
          includeRequestHeaders:
          - authorization
          - x-tenant-id
          timeout: 2s
          failureMode: deny
        jwtAuth:
          issuer: https://api.xavyo.net
          jwks:
            url: https://api.xavyo.net/.well-known/jwks.json
