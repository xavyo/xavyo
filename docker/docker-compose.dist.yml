# =============================================================================
# xavyo IDP — Production Deployment (pre-built images, no source code needed)
# =============================================================================
# Prerequisites:
#   1. Generate JWT keys:
#        mkdir -p keys
#        openssl genpkey -algorithm RSA -out keys/jwt_private.pem -pkeyopt rsa_keygen_bits:2048
#        openssl rsa -pubout -in keys/jwt_private.pem -out keys/jwt_public.pem
#        chmod 600 keys/jwt_private.pem
#   2. Configure passwords:
#        cp .env.dist.example .env    # or set env vars
#   3. Start:  docker compose -f docker-compose.dist.yml up -d
#   4. Health: curl http://localhost:8080/readyz
#   5. Web UI: http://localhost:3000

services:
  # ===========================================================================
  # PostgreSQL Database
  # ===========================================================================
  postgres:
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-xavyo}
      POSTGRES_USER: ${POSTGRES_USER:-xavyo}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?Set POSTGRES_PASSWORD in .env or environment}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    shm_size: 256m
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=256m
      - /run/postgresql:size=32m
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 2g
          cpus: '2.0'
        reservations:
          memory: 512m
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER:-xavyo} -d ${POSTGRES_DB:-xavyo}']
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    logging:
      driver: json-file
      options:
        max-size: '10m'
        max-file: '3'
    networks:
      - xavyo-backend

  # ===========================================================================
  # xavyo IDP API Server
  # ===========================================================================
  idp-api:
    image: ghcr.io/xavyo/xavyo-idp:${VERSION:-latest}
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    entrypoint: ["/bin/sh", "-c", "export JWT_PRIVATE_KEY=\"$(cat /app/keys/jwt_private.pem)\" JWT_PUBLIC_KEY=\"$(cat /app/keys/jwt_public.pem)\" && exec /app/idp-api"]
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER:-xavyo}:${POSTGRES_PASSWORD:?required}@postgres:5432/${POSTGRES_DB:-xavyo}
      ISSUER_URL: ${ISSUER_URL:?Set ISSUER_URL to your public domain e.g. https://auth.example.com}
      HOST: 0.0.0.0
      PORT: 8080
      RUST_LOG: ${RUST_LOG:-info,tower_http=info}
      CORS_ORIGINS: ${CORS_ORIGINS:?Set CORS_ORIGINS to your frontend URL}
      # Email — configure a real SMTP provider
      EMAIL_SMTP_HOST: ${EMAIL_SMTP_HOST:?Set EMAIL_SMTP_HOST}
      EMAIL_SMTP_PORT: ${EMAIL_SMTP_PORT:-587}
      EMAIL_SMTP_TLS: ${EMAIL_SMTP_TLS:-true}
      EMAIL_SMTP_USERNAME: ${EMAIL_SMTP_USERNAME:?Set EMAIL_SMTP_USERNAME}
      EMAIL_SMTP_PASSWORD: ${EMAIL_SMTP_PASSWORD:?Set EMAIL_SMTP_PASSWORD}
      EMAIL_FROM_ADDRESS: ${EMAIL_FROM_ADDRESS:?Set EMAIL_FROM_ADDRESS}
      FRONTEND_BASE_URL: ${FRONTEND_BASE_URL:?Set FRONTEND_BASE_URL to your web UI URL}
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@xavyo.local}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:?Set ADMIN_PASSWORD}
      # Encryption keys — generate with: openssl rand -base64 32
      XAVYO_TICKETING_ENCRYPTION_KEY: ${XAVYO_TICKETING_ENCRYPTION_KEY:?Generate with openssl rand -base64 32}
      XAVYO_SIEM_ENCRYPTION_KEY: ${XAVYO_SIEM_ENCRYPTION_KEY:?Generate with openssl rand -base64 32}
      APP_ENV: production
    ports:
      - '${API_PORT:-8080}:8080'
    volumes:
      - ./keys:/app/keys:ro
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=64m
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 1g
          cpus: '2.0'
        reservations:
          memory: 256m
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8080/readyz']
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: '50m'
        max-file: '5'
    networks:
      - xavyo-backend
      - xavyo-frontend

  # ===========================================================================
  # xavyo Web Frontend (SvelteKit)
  # ===========================================================================
  web:
    image: ghcr.io/xavyo/xavyo-web:${VERSION:-latest}
    restart: unless-stopped
    depends_on:
      idp-api:
        condition: service_healthy
    environment:
      API_BASE_URL: http://idp-api:8080
      NODE_ENV: production
      PORT: 3000
      HOST: 0.0.0.0
    ports:
      - '${WEB_PORT:-3000}:3000'
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=64m
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 512m
          cpus: '1.0'
        reservations:
          memory: 128m
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/']
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 15s
    logging:
      driver: json-file
      options:
        max-size: '10m'
        max-file: '3'
    networks:
      - xavyo-frontend

# =============================================================================
# Networks — backend is internal-only, frontend is exposed
# =============================================================================
networks:
  xavyo-backend:
    driver: bridge
    internal: true
  xavyo-frontend:
    driver: bridge

# =============================================================================
# Volumes
# =============================================================================
volumes:
  postgres_data:
